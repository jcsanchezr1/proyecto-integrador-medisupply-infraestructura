{
	"info": {
		"_postman_id": "def80682-ee87-40cd-a888-4da2df747b10",
		"name": "Medisupply - Keycloak",
		"description": "Colección para administrar usuarios y tokens en Keycloak (medisupply-realm)",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "2750860",
		"_collection_link": "https://timecontrol.postman.co/workspace/TCT~e4bf613c-84ca-4624-ad9c-4c8c0259e211/collection/2750860-def80682-ee87-40cd-a888-4da2df747b10?action=share&source=collection_link&creator=2750860"
	},
	"item": [
		{
			"name": "1. Obtener token admin (master / admin-cli)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var data = pm.response.json();",
							"if (data && data.access_token) { pm.globals.set('KC_ADMIN_TOKEN', data.access_token); }"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "grant_type",
							"value": "password"
						},
						{
							"key": "client_id",
							"value": "admin-cli"
						},
						{
							"key": "username",
							"value": "{{KC_ADMIN_USER}}"
						},
						{
							"key": "password",
							"value": "{{KC_ADMIN_PASS}}"
						}
					]
				},
				"url": {
					"raw": "{{KC_BASE_URL}}/realms/master/protocol/openid-connect/token",
					"host": [
						"{{KC_BASE_URL}}"
					],
					"path": [
						"realms",
						"master",
						"protocol",
						"openid-connect",
						"token"
					]
				}
			},
			"response": []
		},
		{
			"name": "2. Crear usuario (realm: medisupply-realm)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Extraer el ID del usuario de la respuesta Location header",
							"var location = pm.response.headers.get('Location');",
							"if (location) {",
							"  var userId = location.split('/').pop();",
							"  pm.globals.set('NEW_USER_ID', userId);",
							"  console.log('Usuario creado con ID:', userId);",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{KC_ADMIN_TOKEN}}"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"username\": \"{{NEW_USER_EMAIL}}\",\n  \"email\": \"{{NEW_USER_EMAIL}}\",\n  \"firstName\": \"{{NEW_USER_FIRSTNAME}}\",\n  \"lastName\": \"{{NEW_USER_LASTNAME}}\",\n  \"enabled\": true,\n  \"emailVerified\": true,\n  \"credentials\": [\n    { \n      \"type\": \"password\", \n      \"value\": \"user1\", \n      \"temporary\": false \n    }\n  ]\n}"
				},
				"url": {
					"raw": "{{KC_BASE_URL}}/admin/realms/medisupply-realm/users",
					"host": [
						"{{KC_BASE_URL}}"
					],
					"path": [
						"admin",
						"realms",
						"medisupply-realm",
						"users"
					]
				}
			},
			"response": []
		},
		{
			"name": "3. Asignar rol Administrador al usuario",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{KC_ADMIN_TOKEN}}"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "[\n  {\n    \"id\": \"7f3a2d1e-6b0b-4f32-9c96-6a2a2b5f5a11\",\n    \"name\": \"Administrador\",\n    \"description\": \"Rol administrador del realm para la app Medisupply\",\n    \"composite\": false,\n    \"clientRole\": false,\n    \"containerId\": \"medisupply-realm\"\n  }\n]"
				},
				"url": {
					"raw": "{{KC_BASE_URL}}/admin/realms/medisupply-realm/users/{{NEW_USER_ID}}/role-mappings/realm",
					"host": [
						"{{KC_BASE_URL}}"
					],
					"path": [
						"admin",
						"realms",
						"medisupply-realm",
						"users",
						"{{NEW_USER_ID}}",
						"role-mappings",
						"realm"
					]
				}
			},
			"response": []
		},
		{
			"name": "4. Obtener token (password grant) - user creado",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "grant_type",
							"value": "password"
						},
						{
							"key": "client_id",
							"value": "medisupply-app"
						},
						{
							"key": "username",
							"value": "{{NEW_USER_EMAIL}}"
						},
						{
							"key": "password",
							"value": "user1"
						}
					]
				},
				"url": {
					"raw": "{{KC_BASE_URL}}/realms/medisupply-realm/protocol/openid-connect/token",
					"host": [
						"{{KC_BASE_URL}}"
					],
					"path": [
						"realms",
						"medisupply-realm",
						"protocol",
						"openid-connect",
						"token"
					]
				}
			},
			"response": []
		},
		{
			"name": "5. Obtener token (password grant) - user admin",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "grant_type",
							"value": "password"
						},
						{
							"key": "client_id",
							"value": "medisupply-app"
						},
						{
							"key": "username",
							"value": "{{USER_EMAIL}}"
						},
						{
							"key": "password",
							"value": "{{USER_PASSWORD}}"
						}
					]
				},
				"url": {
					"raw": "{{KC_BASE_URL}}/realms/medisupply-realm/protocol/openid-connect/token",
					"host": [
						"{{KC_BASE_URL}}"
					],
					"path": [
						"realms",
						"medisupply-realm",
						"protocol",
						"openid-connect",
						"token"
					]
				}
			},
			"response": []
		}
	],
	"variable": [
		{
			"key": "KC_BASE_URL",
			"value": "http://localhost:8080"
		},
		{
			"key": "KC_ADMIN_USER",
			"value": "admin"
		},
		{
			"key": "KC_ADMIN_PASS",
			"value": "admin"
		},
		{
			"key": "NEW_USER_EMAIL",
			"value": "nuevo.usuario@medisupply.com"
		},
		{
			"key": "NEW_USER_FIRSTNAME",
			"value": "Nuevo"
		},
		{
			"key": "NEW_USER_LASTNAME",
			"value": "Usuario"
		},
		{
			"key": "NEW_USER_PASSWORD",
			"value": "C0ntra$eña"
		},
		{
			"key": "USER_EMAIL",
			"value": "medisupply05@gmail.com"
		},
		{
			"key": "USER_PASSWORD",
			"value": "admin"
		},
		{
			"key": "ADMIN_ROLE_ID",
			"value": "obtener_del_realm"
		}
	]
}